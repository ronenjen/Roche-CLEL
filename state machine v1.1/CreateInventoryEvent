using Biosero.DataServices.Client;
using Biosero.Orchestrator.WorkflowService;
using Newtonsoft.Json;
using System;
using System.Threading;
using System.Threading.Tasks;

/*
Script written by Ronen Peleg (ronenpeleg@biosero.com)

Description:
Registers a new InventorySentEvent
*/


namespace Biosero.Scripting
{
    public class CreateInventoryEvent
    {
        public async Task RunAsync(DataServicesClient client, WorkflowContext context, CancellationToken cancellationToken)
        {
            //New InventorySentEvent called Transfer with current timestamp and "Roche-Orchestrator" set as actor
            InventorySentEvent transfer = new InventorySentEvent()
            {
                TimeStamp = DateTime.Now,
                OperatorIdentifier = "Roche-Orchestrator",
            };

            var now = DateTimeOffset.Now;
            //Add the new inventory event using the TRANSFER data defined above
            await client.AddEventAsync(new AddEventCommand
            {
                Topic = "Biosero.Scripting.InventorySentEvent",
                Data = JsonConvert.SerializeObject(transfer),
                Start = now,
                End = now,
                ActorId = "Roche-Orchestrator",
                OperatorId = "Roche-Orchestrator",
                Subjects = new string[] { "" }
            });

            Serilog.Log.Information("Inventory Operation Required= Yes");
        }
    }

    // Class defining the structure of the InventorySentEvent
    public class InventorySentEvent
    {
        public DateTimeOffset TimeStamp { get; set; }

        public string OperatorIdentifier { get; set; }
    }
}