using Biosero.DataServices.Client;
using Biosero.Orchestrator.WorkflowService;
using Newtonsoft.Json;
using System;
using System.Threading;
using System.Threading.Tasks;

/*
Script written by Ronen Peleg (ronenpeleg@biosero.com)

Description:
Registers a new CreateREMPONEvent
*/

namespace Biosero.Scripting
{
    public class CreateREMPONEvent
    {
        public async Task RunAsync(DataServicesClient client, WorkflowContext context, CancellationToken cancellationToken)
        {
            string RequestedOrder = context.GetGlobalVariableValue<string>("Input.OrderId");
            bool REMPToBeDone =  context.GetGlobalVariableValue<bool>("REMPOnToBeDone");


            await context.AddOrUpdateGlobalVariableAsync("REMPOnToBeDone", true);

            //New REMPOnEvent called Transfer with current timestamp and "Roche-Orchestrator" set as actor
            REMPOnEvent transfer = new REMPOnEvent()
            {
                TimeStamp = DateTime.Now,
                OperatorIdentifier = "Roche-Orchestrator",
                REMPON = REMPToBeDone,
                OrderID = RequestedOrder,

            };

            var now = DateTimeOffset.Now;

            //Add the new tips event using the TRANSFER data defined above
            await client.AddEventAsync(new AddEventCommand
            {
                Topic = "Biosero.Scripting.REMPOnEvent",
                Data = JsonConvert.SerializeObject(transfer),
                Start = now,
                End = now,
                ActorId = "Roche-Orchestrator",
                OperatorId = "Roche-Orchestrator",
                Subjects = new string[] { "" }
            });

            Serilog.Log.Information("REMPOnEvent= Yes");
        }
    }

    // Class defining the structure of the REMPOnEvent
    public class REMPOnEvent
    {
        public DateTimeOffset TimeStamp { get; set; }

        public string OperatorIdentifier { get; set; }

        public string OrderID { get; set; }
        
        public Boolean REMPON { get; set; }
    }
}