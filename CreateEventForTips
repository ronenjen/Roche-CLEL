using Biosero.DataServices.Client;
using Biosero.Orchestrator.WorkflowService;
using Newtonsoft.Json;
using System;
using System.Threading;
using System.Threading.Tasks;

/*
Script written by Ronen Peleg (ronenpeleg@biosero.com)

Description:
Registers a new TipsSentEvent
*/

namespace Biosero.Scripting
{
    public class CreateEventForTips
    {
        public async Task RunAsync(DataServicesClient client, WorkflowContext context, CancellationToken cancellationToken)
        {
            //New TipsSentEvent called Transfer with current timestamp and "Roche-Orchestrator" set as actor
            TipsSentEvent transfer = new TipsSentEvent()
            {
                TimeStamp = DateTime.Now,
                OperatorIdentifier = "Roche-Orchestrator",
            };

            var now = DateTimeOffset.Now;

            //Add the new tips event using the TRANSFER data defined above
            await client.AddEventAsync(new AddEventCommand
            {
                Topic = "Biosero.Scripting.TipsSentEvent",
                Data = JsonConvert.SerializeObject(transfer),
                Start = now,
                End = now,
                ActorId = "Roche-Orchestrator",
                OperatorId = "Roche-Orchestrator",
                Subjects = new string[] { "" }
            });

            Serilog.Log.Information("TecanTipRacksSent= Yes");
        }
    }

    // Class defining the structure of the TipsSentEvent
    public class TipsSentEvent
    {
        public DateTimeOffset TimeStamp { get; set; }

        public string OperatorIdentifier { get; set; }
    }
}
